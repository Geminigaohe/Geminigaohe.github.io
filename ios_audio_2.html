<!DOCTYPE HTML>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <meta name="Keywords" content="blog"/>
    <meta name="Description" content="blog"/>
    <title>iOS 使用 AVPlayer 播放网络音乐 (转载)</title>
    <link rel="shortcut icon" href="/static/favicon.png"/>
    <link rel="stylesheet" type="text/css" href="/main.css" />
</head>
<body>
<div class="main">
    <div class="header">
    	<ul id="pages">
            <li><a href="/">home</a></li>
            <li><a href="/#/tags">tags</a></li>
            <li><a href="/#/archive">archive</a></li>
    	</ul>
    </div>
	<div class="wrap-header">
	<h1>
    <a href="/" id="title"></a>
	</h1>
	</div>
<div id="md" style="display: none;">
<!-- markdown -->
<center>![](https://raw.githubusercontent.com/Geminigaohe/Geminigaohe.github.io/master/icon/ios7-musical-notes.png)</center>

##引言

假如你现在打算做一个类似百度音乐, 豆瓣电台的在线音乐类APP, 你会怎样做?

首先了解一下**音频播放的实现级别:**

1. 离线播放: 这里并不是指应用不联网, 而是指播放本地音频文件, 包括先下完完成音频文件再进行播放的情况, 这种使用 AVFoundation Framework 中的 AVAudioPlayer 可以满足.

2. 在线播放: 使用 AVFoundation Framework 中的 AVPlayer 可以满足.

3. 在线播放同时存储文件: 使用
AudioFileStreamer ＋ AudioQueue 可以满足.
4. 在线播放且带有音效处理: 使用
AudioFileStreamer ＋ AudioQueue ＋ 音效模块 (系统自带或者
自行开发) 来满足.

本文主要针对第二种级别, 介绍如何使用 AVPlayer 实现网络音乐的播放.


## 什么是AVPlayer

AVPlayer 存在于 AVFoundation Framework 中，其实它是一个视频播放器, 但是用它来播放音乐是没问题的, 当然播放音乐不需要呈现界面, 因此我们不需要实现它的界面逻辑.

与 AVPlayer 联系密切的类：

* Asset: AVAsset 是抽象类, 不能直接使用, 其子类 AVURLAsset 可以根据 URL 生成包含媒体信息的Asset对象.

* AVPlayerItem: 和媒体资源存在对应关系, 管理媒体资源的信息和状态.

## 功能需求:

通常音乐播放并展示到界面上需要我们实现的功能如下：

* (核心) 播放器通过一个网络链接播放音乐.

*  (基本) 播放器的常用操作: 暂停 播放 上一首  下一首等等.
*  (基本) 监听该音乐的播放进度 获取音乐的总时间、当前播放时间.
*  (基本) 监听改播放器状态：
 *  媒体加载状态
 *  数据缓冲状态
 *  播放完毕状态
*  (可选) Remote Control 控制音乐的播放.
*  (可选) Now Playing Center 展示正在播放的音乐.

## 功能实现

### 1. 通过一个网络链接播放音乐:

~~~~{c}
NSURL *url  = [NSURL URLWithString:self.currentSong.url];
AVPlayerItem *songItem = [[AVPlayerItem alloc]initWithURL:url];
AVPlayer *player = [[AVPlayer alloc]initWithPlayerItem:songItem];
~~~~
这里是用一个 asset 来初始化 player, 当然你也可以直接用 URL 初始化：

~~~~{c}
AVPlayer *player = [[AVPlayer alloc] initWithURL:url];
~~~~
需要获取当前播放的 item 可以这样获取:

~~~~{c}
AVPlayerItem *songItem = player.currentItem;
~~~~

### 2. 播放器的常用操作

播放: 

~~~~{c}
[player play];
~~~~

需要注意的是初始化完 player 之后不一定会马上开始播放, 需要等待 player 的状态变为 **ReadyToPlay** 才会进行播放.

暂停:

~~~~{c}
[player pause];
~~~~

上一首 下一首:
这里我们有两种方式可以实现, 一种是由你自行控制下一首歌曲的 item, 将其替换到当前播放的item:

~~~~{c}
[player replaceCurrentItemWithPlayerItem:songItem];
~~~~

另一种是使用 AVPlaye r的子类 AVQueuePlayer 来播放多个 item, 调用 `advanceToNextItem:` 方法来播放下一首音乐.

~~~~{c}
NSArray * items = @[item1, item2, item3 ....];
AVQueuePlayer * queuePlayer = [[AVQueuePlayer alloc]initWithItems:items];
~~~~

### 3. 监听播放进度

使用`addPeriodicTimeObserverForInterval:queue:usingBlock:` 来监听播放器的进度
注意:

* 方法传入一个 CMTime 结构体, 每到一定时间都会回调一次, 包括开始和结束播放.
2. 如果 block 里面的操作耗时太长, 下次不一定会收到回调, 所以尽量减少block的操作耗时.
3. 方法会返回一个观察者对象, 当播放完毕时需要移除这个观察者.

添加观察者:
~~~~{c}
id timeObserve = [self.player addPeriodicTimeObserverForInterval:CMTimeMake(1.0, 1.0) queue:dispatch_get_main_queue() usingBlock:^(CMTime time) {
        float current = CMTimeGetSeconds(time);        
        float total = CMTimeGetSeconds(songItem.duration);        
        if (current) {            
              weakSelf.progress = current / total;            
              weakSelf.playTime = [NSString stringWithFormat:@"%.f",current];            
              weakSelf.playDuration = [NSString stringWithFormat:@"%.2f",total];        }
    }];

~~~~
移除观察者:
~~~~{c}
if (timeObserve) {
        [player removeTimeObserver:_timeObserve];
        timeObserve = nil;
    }
~~~~

### 4、监听改播放器状态

* 媒体加载状态
~~~~{c}
[songItem addObserver:self forKeyPath:@"status" options:NSKeyValueObservingOptionNew context:nil];

然后可以在KVO方法中获取其status的改变

- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary<NSString *,id> *)change context:(void *)context {

    if ([keyPath isEqualToString:@"status"]) {
        switch (self.player.status) {            
            case AVPlayerStatusUnknown:                
                BASE_INFO_FUN(@"KVO：未知状态，此时不能播放");                
                break;            
            case AVPlayerStatusReadyToPlay:                
                self.status = SUPlayStatusReadyToPlay;                    
                BASE_INFO_FUN(@"KVO：准备完毕，可以播放");                
                break;
            case AVPlayerStatusFailed:
                BASE_INFO_FUN(@"KVO：加载失败，网络或者服务器出现问题");
                break;            
            default:                
                break;        
        }
    }
}
~~~~

一般初始化 player 到播放都会经历
 Unknown 到 ReadyToPlay 这个过程, 网络情况良好时可能不会出现 Unknown 状态的提示, 网络情况差的时候 Unknown 的状态可能会持续比较久甚至可能不进入 ReadyToPlay 状态, 针对这种情况我们要做特殊的处理.

播放完成之后需要移除观察者:

~~~~{c}
[songItem removeObserver:self forKeyPath:@"status"];
~~~~

* 数据缓冲状态

~~~~{c}
[songItem addObserver:self forKeyPath:@"loadedTimeRanges" options:NSKeyValueObservingOptionNew context:nil];
~~~~
然后可以在 KVO 方法中获取其 status 的改变:

~~~~{c}
- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary<NSString *,id> *)change context:(void *)context {   
    AVPlayerItem * songItem = object;
    if ([keyPath isEqualToString:@"loadedTimeRanges"]) {
        NSArray * array = songItem.loadedTimeRanges;        
        CMTimeRange timeRange = [array.firstObject CMTimeRangeValue]; //本次缓冲的时间范围
        NSTimeInterval totalBuffer = CMTimeGetSeconds(timeRange.start) + CMTimeGetSeconds(timeRange.duration); //缓冲总长度
        SuLog(@"共缓冲%.2f",totalBuffer);
    }
}
~~~~
如果你需要在进度条展示缓冲的进度, 可以增加这个观察者.

播放完成之后需要移除观察者:

~~~~{c}
[songItem removeObserver:self forKeyPath:@" loadedTimeRanges"];
~~~~

* 播放完毕状态
监听 AVPlayer 播放完成通知

~~~~{c}
[[NSNotificationCenter defaultCenter] addObserver:self selector:@selector(playbackFinished:) name:AVPlayerItemDidPlayToEndTimeNotification object:songItem];

- (void)playbackFinished:(NSNotification *)notice {    
    BASE_INFO_FUN(@"播放完成");    
    [self playNext];
}
~~~~

播放完毕后, 一般都会进行播放下一首的操作.

播放下一首前, 别忘了移除这个 item 的观察者:

~~~~{c}
[[NSNotificationCenter defaultCenter] removeObserver:self];
~~~~

### 5. Remote Control 控制音乐的播放

Remote Control 可以让你在不打开 APP 的情况下控制其播放, 最常见的出现于锁屏界面 从屏幕底部上拉和耳机线控三种, 可以达到增强用户体验的作用.

我们在 AppDelegate 里去设置 Remote Control :

* 声明接收 Remote Control 事件:
~~~~{c}
[[UIApplication sharedApplication] beginReceivingRemoteControlEvents];
~~~~

*  重写方法, 成为第一响应者:

~~~~{c}
- (BOOL)canBecomeFirstResponder {    
    return YES;
}
~~~~

* 对事件进行处理:

~~~~{c}
- (void)remoteControlReceivedWithEvent:(UIEvent *)event {       
    switch (event.subtype)    {        
        case UIEventSubtypeRemoteControlPlay:
            [self.player startPlay];
            BASE_INFO_FUN(@“remote_播放");
            break;        
        case UIEventSubtypeRemoteControlPause:            
            [self.player pausePlay];
            BASE_INFO_FUN(@"remote_暂停");
            break;        
        case UIEventSubtypeRemoteControlNextTrack:
            [self.player playNextSong];
            BASE_INFO_FUN(@"remote_下一首");
            break;        
        case UIEventSubtypeRemoteControlTogglePlayPause:            
            self.player.isPlaying ? [self.player pausePlay] : [self.player startPlay];           
            BASE_INFO_FUN(@“remote_耳机的播放/暂停");
            break;        
        default:            
            break;    }
}
~~~~

### 6. Now Playing Center

Now Playing Center 可以在锁屏界面展示音乐的信息, 也达到增强用户体验的作用.

~~~~{c}
- (void)configNowPlayingCenter {    BASE_INFO_FUN(@"配置NowPlayingCenter");
    NSMutableDictionary * info = [NSMutableDictionary dictionary];
    //音乐的标题
    [info setObject:_player.currentSong.title forKey:MPMediaItemPropertyTitle];
     //音乐的艺术家
    [info setObject:_player.currentSong.artist forKey:MPMediaItemPropertyArtist];
     //音乐的播放时间
    [info setObject:@(self.player.playTime.intValue) forKey:MPNowPlayingInfoPropertyElapsedPlaybackTime];
     //音乐的播放速度
    [info setObject:@(1) forKey:MPNowPlayingInfoPropertyPlaybackRate];
     //音乐的总时间
    [info setObject:@(self.player.playDuration.intValue) forKey:MPMediaItemPropertyPlaybackDuration];
     //音乐的封面
    MPMediaItemArtwork * artwork = [[MPMediaItemArtwork alloc] initWithImage:_player.coverImg];
    [info setObject:artwork forKey:MPMediaItemPropertyArtwork];
     //完成设置
    [[MPNowPlayingInfoCenter defaultCenter]setNowPlayingInfo:info];
}
~~~~

Now Playing Center 并不需要每一秒都去刷新 (设置), 它是根据你设置的 PlaybackRate 来计算进度条展示的进度, 比如你 PlaybackRate 传 1，那就是1秒刷新一次进度显示, 当然暂停播放的时候它也会自动暂停.

那什么时候设置 Now Playing Center 比较合适呢? 对于播放网络音乐来说, 需要刷新的有几个时间点: 当前播放的歌曲变化时 (如切换到下一首) 当前歌曲信息变化时 (如从Unknown到ReadyToPlay) 当前歌曲拖动进度时.

## 关于总体的播放逻辑

总结一下音乐播放器的播放逻辑:

1. 初始化播放界面
2. 从接口获取播放列表 选择第一首为当前播放歌曲.
3. 根据当前歌曲初始化播放器 、同步歌曲信息到播放界面 (此时播放界面应展示歌曲信息, 但是播放按钮应不可用且有 loading 之类的提示表示正在加载歌曲) 同步歌曲信息到 Now Playing Center.
4. 当播放器的 status 变为 Ready To Play 时, 播放歌曲、同步播放信息到播放界面 (播放时间 总时间 进度条等等)  同步播放信息到 Now Playing Center.
5. 当用户进行暂停操作时, 刷新播放界面.
6. 当用户进行下一首 上一首操作时, 或完成某一首歌曲的播放时, 将对应的歌曲设置为当前播放歌曲, 重复3-5步骤.
7. 由于网络情况不好造成播放器自动暂停播放时, 应刷新播放界面.
8. 由于网络情况不好造成播放器不能进入播放状态时, 应有所处理 (比如提示耐心等待或者播放本地离线的歌曲).

## 后记

本文仅以实现基本功能的角度介绍了 AVPlayer 来播放网络音乐的实现, 事实上 AVPlayer 的功能不仅于此, 有兴趣的同学可以深入学习AVFoundation Framework.

如有读者需要类似豆瓣电台 APP 的项目 demo 可以到[电台律动](http://www.jianshu.com/p/819fbc4934d2)下载学习。

___
[原文链接](http://www.jianshu.com/p/32b932f44c9b)

<!-- markdown end -->
</div>
<div class="entry" id="main">
<!-- content -->
<p></p><center><img src="https://raw.githubusercontent.com/Geminigaohe/Geminigaohe.github.io/master/icon/ios7-musical-notes.png" alt="" title=""></center><p></p>

<h2 id="">引言</h2>

<p>假如你现在打算做一个类似百度音乐, 豆瓣电台的在线音乐类APP, 你会怎样做?</p>

<p>首先了解一下<strong>音频播放的实现级别:</strong></p>

<ol>
<li><p>离线播放: 这里并不是指应用不联网, 而是指播放本地音频文件, 包括先下完完成音频文件再进行播放的情况, 这种使用 AVFoundation Framework 中的 AVAudioPlayer 可以满足.</p></li>
<li><p>在线播放: 使用 AVFoundation Framework 中的 AVPlayer 可以满足.</p></li>
<li><p>在线播放同时存储文件: 使用
AudioFileStreamer ＋ AudioQueue 可以满足.</p></li>
<li>在线播放且带有音效处理: 使用
AudioFileStreamer ＋ AudioQueue ＋ 音效模块 (系统自带或者
自行开发) 来满足.</li>
</ol>

<p>本文主要针对第二种级别, 介绍如何使用 AVPlayer 实现网络音乐的播放.</p>

<h2 id="avplayer">什么是AVPlayer</h2>

<p>AVPlayer 存在于 AVFoundation Framework 中，其实它是一个视频播放器, 但是用它来播放音乐是没问题的, 当然播放音乐不需要呈现界面, 因此我们不需要实现它的界面逻辑.</p>

<p>与 AVPlayer 联系密切的类：</p>

<ul>
<li><p>Asset: AVAsset 是抽象类, 不能直接使用, 其子类 AVURLAsset 可以根据 URL 生成包含媒体信息的Asset对象.</p></li>
<li><p>AVPlayerItem: 和媒体资源存在对应关系, 管理媒体资源的信息和状态.</p></li>
</ul>

<h2 id="">功能需求:</h2>

<p>通常音乐播放并展示到界面上需要我们实现的功能如下：</p>

<ul>
<li><p>(核心) 播放器通过一个网络链接播放音乐.</p></li>
<li><p>(基本) 播放器的常用操作: 暂停 播放 上一首  下一首等等.</p></li>
<li>(基本) 监听该音乐的播放进度 获取音乐的总时间、当前播放时间.</li>
<li>(基本) 监听改播放器状态：
<ul><li>媒体加载状态</li>
<li>数据缓冲状态</li>
<li>播放完毕状态</li></ul></li>
<li>(可选) Remote Control 控制音乐的播放.</li>
<li>(可选) Now Playing Center 展示正在播放的音乐.</li>
</ul>

<h2 id="">功能实现</h2>

<h3 id="1">1. 通过一个网络链接播放音乐:</h3>

<pre class=" language-c"><code class=" language-c">NSURL <span class="token operator">*</span>url  <span class="token operator">=</span> <span class="token punctuation">[</span>NSURL URLWithString<span class="token punctuation">:</span>self<span class="token punctuation">.</span>currentSong<span class="token punctuation">.</span>url<span class="token punctuation">]</span><span class="token punctuation">;</span>
AVPlayerItem <span class="token operator">*</span>songItem <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>AVPlayerItem alloc<span class="token punctuation">]</span>initWithURL<span class="token punctuation">:</span>url<span class="token punctuation">]</span><span class="token punctuation">;</span>
AVPlayer <span class="token operator">*</span>player <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>AVPlayer alloc<span class="token punctuation">]</span>initWithPlayerItem<span class="token punctuation">:</span>songItem<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>这里是用一个 asset 来初始化 player, 当然你也可以直接用 URL 初始化：

<pre class=" language-c"><code class=" language-c">AVPlayer <span class="token operator">*</span>player <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>AVPlayer alloc<span class="token punctuation">]</span> initWithURL<span class="token punctuation">:</span>url<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>需要获取当前播放的 item 可以这样获取:

<pre class=" language-c"><code class=" language-c">AVPlayerItem <span class="token operator">*</span>songItem <span class="token operator">=</span> player<span class="token punctuation">.</span>currentItem<span class="token punctuation">;</span>
</code></pre>

<h3 id="2">2. 播放器的常用操作</h3>

<p>播放: </p>

<pre class=" language-c"><code class=" language-c"><span class="token punctuation">[</span>player play<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>

<p>需要注意的是初始化完 player 之后不一定会马上开始播放, 需要等待 player 的状态变为 <strong>ReadyToPlay</strong> 才会进行播放.</p>

<p>暂停:</p>

<pre class=" language-c"><code class=" language-c"><span class="token punctuation">[</span>player pause<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>

<p>上一首 下一首:
这里我们有两种方式可以实现, 一种是由你自行控制下一首歌曲的 item, 将其替换到当前播放的item:</p>

<pre class=" language-c"><code class=" language-c"><span class="token punctuation">[</span>player replaceCurrentItemWithPlayerItem<span class="token punctuation">:</span>songItem<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>

<p>另一种是使用 AVPlaye r的子类 AVQueuePlayer 来播放多个 item, 调用 <code>advanceToNextItem:</code> 方法来播放下一首音乐.</p>

<pre class=" language-c"><code class=" language-c">NSArray <span class="token operator">*</span> items <span class="token operator">=</span> @<span class="token punctuation">[</span>item1<span class="token punctuation">,</span> item2<span class="token punctuation">,</span> item3 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
AVQueuePlayer <span class="token operator">*</span> queuePlayer <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>AVQueuePlayer alloc<span class="token punctuation">]</span>initWithItems<span class="token punctuation">:</span>items<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>

<h3 id="3">3. 监听播放进度</h3>

<p>使用<code>addPeriodicTimeObserverForInterval:queue:usingBlock:</code> 来监听播放器的进度
注意:</p>

<ul>
<li>方法传入一个 CMTime 结构体, 每到一定时间都会回调一次, 包括开始和结束播放.</li>
<li>如果 block 里面的操作耗时太长, 下次不一定会收到回调, 所以尽量减少block的操作耗时.</li>
<li>方法会返回一个观察者对象, 当播放完毕时需要移除这个观察者.</li>
</ul>

<p>添加观察者:</p>

<pre class=" language-c"><code class=" language-c">id timeObserve <span class="token operator">=</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>player addPeriodicTimeObserverForInterval<span class="token punctuation">:</span><span class="token function">CMTimeMake<span class="token punctuation">(</span></span><span class="token number">1.0</span><span class="token punctuation">,</span> <span class="token number">1.0</span><span class="token punctuation">)</span> queue<span class="token punctuation">:</span><span class="token function">dispatch_get_main_queue<span class="token punctuation">(</span></span><span class="token punctuation">)</span> usingBlock<span class="token punctuation">:</span><span class="token operator">^</span><span class="token punctuation">(</span>CMTime time<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">float</span> current <span class="token operator">=</span> <span class="token function">CMTimeGetSeconds<span class="token punctuation">(</span></span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token keyword">float</span> total <span class="token operator">=</span> <span class="token function">CMTimeGetSeconds<span class="token punctuation">(</span></span>songItem<span class="token punctuation">.</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span>        
        <span class="token keyword">if</span> <span class="token punctuation">(</span>current<span class="token punctuation">)</span> <span class="token punctuation">{</span>            
              weakSelf<span class="token punctuation">.</span>progress <span class="token operator">=</span> current <span class="token operator">/</span> total<span class="token punctuation">;</span>            
              weakSelf<span class="token punctuation">.</span>playTime <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span>@<span class="token string">"%.f"</span><span class="token punctuation">,</span>current<span class="token punctuation">]</span><span class="token punctuation">;</span>            
              weakSelf<span class="token punctuation">.</span>playDuration <span class="token operator">=</span> <span class="token punctuation">[</span>NSString stringWithFormat<span class="token punctuation">:</span>@<span class="token string">"%.2f"</span><span class="token punctuation">,</span>total<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

</code></pre>移除观察者:
<pre class=" language-c"><code class=" language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span>timeObserve<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>player removeTimeObserver<span class="token punctuation">:</span>_timeObserve<span class="token punctuation">]</span><span class="token punctuation">;</span>
        timeObserve <span class="token operator">=</span> nil<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>

<h3 id="4">4、监听改播放器状态</h3>

<ul>
<li>媒体加载状态</li>
</ul>

<pre class=" language-c"><code class=" language-c"><span class="token punctuation">[</span>songItem addObserver<span class="token punctuation">:</span>self forKeyPath<span class="token punctuation">:</span>@<span class="token string">"status"</span> options<span class="token punctuation">:</span>NSKeyValueObservingOptionNew <span class="token class-name">context</span><span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>

然后可以在KVO方法中获取其status的改变

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>observeValueForKeyPath<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>keyPath ofObject<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>object change<span class="token punctuation">:</span><span class="token punctuation">(</span>NSDictionary<span class="token operator">&lt;</span>NSString <span class="token operator">*</span><span class="token punctuation">,</span>id&gt; <span class="token operator">*</span><span class="token punctuation">)</span>change context<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>context <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>keyPath isEqualToString<span class="token punctuation">:</span>@<span class="token string">"status"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>player<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>            
            <span class="token keyword">case</span> AVPlayerStatusUnknown<span class="token punctuation">:</span>                
                <span class="token function">BASE_INFO_FUN<span class="token punctuation">(</span></span>@<span class="token string">"KVO：未知状态，此时不能播放"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                
                <span class="token keyword">break</span><span class="token punctuation">;</span>            
            <span class="token keyword">case</span> AVPlayerStatusReadyToPlay<span class="token punctuation">:</span>                
                self<span class="token punctuation">.</span>status <span class="token operator">=</span> SUPlayStatusReadyToPlay<span class="token punctuation">;</span>                    
                <span class="token function">BASE_INFO_FUN<span class="token punctuation">(</span></span>@<span class="token string">"KVO：准备完毕，可以播放"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token keyword">case</span> AVPlayerStatusFailed<span class="token punctuation">:</span>
                <span class="token function">BASE_INFO_FUN<span class="token punctuation">(</span></span>@<span class="token string">"KVO：加载失败，网络或者服务器出现问题"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>            
            <span class="token keyword">default</span><span class="token punctuation">:</span>                
                <span class="token keyword">break</span><span class="token punctuation">;</span>        
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>

<p>一般初始化 player 到播放都会经历
 Unknown 到 ReadyToPlay 这个过程, 网络情况良好时可能不会出现 Unknown 状态的提示, 网络情况差的时候 Unknown 的状态可能会持续比较久甚至可能不进入 ReadyToPlay 状态, 针对这种情况我们要做特殊的处理.</p>

<p>播放完成之后需要移除观察者:</p>

<pre class=" language-c"><code class=" language-c"><span class="token punctuation">[</span>songItem removeObserver<span class="token punctuation">:</span>self forKeyPath<span class="token punctuation">:</span>@<span class="token string">"status"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>

<ul>
<li>数据缓冲状态</li>
</ul>

<pre class=" language-c"><code class=" language-c"><span class="token punctuation">[</span>songItem addObserver<span class="token punctuation">:</span>self forKeyPath<span class="token punctuation">:</span>@<span class="token string">"loadedTimeRanges"</span> options<span class="token punctuation">:</span>NSKeyValueObservingOptionNew <span class="token class-name">context</span><span class="token punctuation">:</span>nil<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>然后可以在 KVO 方法中获取其 status 的改变:

<pre class=" language-c"><code class=" language-c"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>observeValueForKeyPath<span class="token punctuation">:</span><span class="token punctuation">(</span>NSString <span class="token operator">*</span><span class="token punctuation">)</span>keyPath ofObject<span class="token punctuation">:</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span>object change<span class="token punctuation">:</span><span class="token punctuation">(</span>NSDictionary<span class="token operator">&lt;</span>NSString <span class="token operator">*</span><span class="token punctuation">,</span>id&gt; <span class="token operator">*</span><span class="token punctuation">)</span>change context<span class="token punctuation">:</span><span class="token punctuation">(</span><span class="token keyword">void</span> <span class="token operator">*</span><span class="token punctuation">)</span>context <span class="token punctuation">{</span>   
    AVPlayerItem <span class="token operator">*</span> songItem <span class="token operator">=</span> object<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">[</span>keyPath isEqualToString<span class="token punctuation">:</span>@<span class="token string">"loadedTimeRanges"</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        NSArray <span class="token operator">*</span> array <span class="token operator">=</span> songItem<span class="token punctuation">.</span>loadedTimeRanges<span class="token punctuation">;</span>        
        CMTimeRange timeRange <span class="token operator">=</span> <span class="token punctuation">[</span>array<span class="token punctuation">.</span>firstObject CMTimeRangeValue<span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> //本次缓冲的时间范围
</span>        NSTimeInterval totalBuffer <span class="token operator">=</span> <span class="token function">CMTimeGetSeconds<span class="token punctuation">(</span></span>timeRange<span class="token punctuation">.</span>start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token function">CMTimeGetSeconds<span class="token punctuation">(</span></span>timeRange<span class="token punctuation">.</span>duration<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true"> //缓冲总长度
</span>        <span class="token function">SuLog<span class="token punctuation">(</span></span>@<span class="token string">"共缓冲%.2f"</span><span class="token punctuation">,</span>totalBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>如果你需要在进度条展示缓冲的进度, 可以增加这个观察者.

播放完成之后需要移除观察者:

<pre class=" language-c"><code class=" language-c"><span class="token punctuation">[</span>songItem removeObserver<span class="token punctuation">:</span>self forKeyPath<span class="token punctuation">:</span>@<span class="token string">" loadedTimeRanges"</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>

<ul>
<li>播放完毕状态
监听 AVPlayer 播放完成通知</li>
</ul>

<pre class=" language-c"><code class=" language-c"><span class="token punctuation">[</span><span class="token punctuation">[</span>NSNotificationCenter defaultCenter<span class="token punctuation">]</span> addObserver<span class="token punctuation">:</span>self selector<span class="token punctuation">:</span>@<span class="token function">selector<span class="token punctuation">(</span></span>playbackFinished<span class="token punctuation">:</span><span class="token punctuation">)</span> name<span class="token punctuation">:</span>AVPlayerItemDidPlayToEndTimeNotification object<span class="token punctuation">:</span>songItem<span class="token punctuation">]</span><span class="token punctuation">;</span>

<span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>playbackFinished<span class="token punctuation">:</span><span class="token punctuation">(</span>NSNotification <span class="token operator">*</span><span class="token punctuation">)</span>notice <span class="token punctuation">{</span>    
    <span class="token function">BASE_INFO_FUN<span class="token punctuation">(</span></span>@<span class="token string">"播放完成"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    
    <span class="token punctuation">[</span>self playNext<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>

<p>播放完毕后, 一般都会进行播放下一首的操作.</p>

<p>播放下一首前, 别忘了移除这个 item 的观察者:</p>

<pre class=" language-c"><code class=" language-c"><span class="token punctuation">[</span><span class="token punctuation">[</span>NSNotificationCenter defaultCenter<span class="token punctuation">]</span> removeObserver<span class="token punctuation">:</span>self<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>

<h3 id="5remotecontrol">5. Remote Control 控制音乐的播放</h3>

<p>Remote Control 可以让你在不打开 APP 的情况下控制其播放, 最常见的出现于锁屏界面 从屏幕底部上拉和耳机线控三种, 可以达到增强用户体验的作用.</p>

<p>我们在 AppDelegate 里去设置 Remote Control :</p>

<ul>
<li>声明接收 Remote Control 事件:</li>
</ul>

<pre class=" language-c"><code class=" language-c"><span class="token punctuation">[</span><span class="token punctuation">[</span>UIApplication sharedApplication<span class="token punctuation">]</span> beginReceivingRemoteControlEvents<span class="token punctuation">]</span><span class="token punctuation">;</span>
</code></pre>

<ul>
<li>重写方法, 成为第一响应者:</li>
</ul>

<pre class=" language-c"><code class=" language-c"><span class="token operator">-</span> <span class="token punctuation">(</span>BOOL<span class="token punctuation">)</span>canBecomeFirstResponder <span class="token punctuation">{</span>    
    <span class="token keyword">return</span> YES<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>

<ul>
<li>对事件进行处理:</li>
</ul>

<pre class=" language-c"><code class=" language-c"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>remoteControlReceivedWithEvent<span class="token punctuation">:</span><span class="token punctuation">(</span>UIEvent <span class="token operator">*</span><span class="token punctuation">)</span>event <span class="token punctuation">{</span>       
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>subtype<span class="token punctuation">)</span>    <span class="token punctuation">{</span>        
        <span class="token keyword">case</span> UIEventSubtypeRemoteControlPlay<span class="token punctuation">:</span>
            <span class="token punctuation">[</span>self<span class="token punctuation">.</span>player startPlay<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">BASE_INFO_FUN<span class="token punctuation">(</span></span>@“remote_播放"<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>        
        <span class="token keyword">case</span> UIEventSubtypeRemoteControlPause<span class="token punctuation">:</span>            
            <span class="token punctuation">[</span>self<span class="token punctuation">.</span>player pausePlay<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">BASE_INFO_FUN<span class="token punctuation">(</span></span>@<span class="token string">"remote_暂停"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>        
        <span class="token keyword">case</span> UIEventSubtypeRemoteControlNextTrack<span class="token punctuation">:</span>
            <span class="token punctuation">[</span>self<span class="token punctuation">.</span>player playNextSong<span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token function">BASE_INFO_FUN<span class="token punctuation">(</span></span>@<span class="token string">"remote_下一首"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>        
        <span class="token keyword">case</span> UIEventSubtypeRemoteControlTogglePlayPause<span class="token punctuation">:</span>            
            self<span class="token punctuation">.</span>player<span class="token punctuation">.</span>isPlaying <span class="token operator">?</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>player pausePlay<span class="token punctuation">]</span> <span class="token punctuation">:</span> <span class="token punctuation">[</span>self<span class="token punctuation">.</span>player startPlay<span class="token punctuation">]</span><span class="token punctuation">;</span>           
            <span class="token function">BASE_INFO_FUN<span class="token punctuation">(</span></span>@“remote_耳机的播放<span class="token operator">/</span>暂停"<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">break</span><span class="token punctuation">;</span>        
        <span class="token keyword">default</span><span class="token punctuation">:</span>            
            <span class="token keyword">break</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>

<h3 id="6nowplayingcenter">6. Now Playing Center</h3>

<p>Now Playing Center 可以在锁屏界面展示音乐的信息, 也达到增强用户体验的作用.</p>

<pre class=" language-c"><code class=" language-c"><span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>configNowPlayingCenter <span class="token punctuation">{</span>    <span class="token function">BASE_INFO_FUN<span class="token punctuation">(</span></span>@<span class="token string">"配置NowPlayingCenter"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    NSMutableDictionary <span class="token operator">*</span> info <span class="token operator">=</span> <span class="token punctuation">[</span>NSMutableDictionary dictionary<span class="token punctuation">]</span><span class="token punctuation">;</span>
   <span class="token comment" spellcheck="true"> //音乐的标题
</span>    <span class="token punctuation">[</span>info setObject<span class="token punctuation">:</span>_player<span class="token punctuation">.</span>currentSong<span class="token punctuation">.</span>title forKey<span class="token punctuation">:</span>MPMediaItemPropertyTitle<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true"> //音乐的艺术家
</span>    <span class="token punctuation">[</span>info setObject<span class="token punctuation">:</span>_player<span class="token punctuation">.</span>currentSong<span class="token punctuation">.</span>artist forKey<span class="token punctuation">:</span>MPMediaItemPropertyArtist<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true"> //音乐的播放时间
</span>    <span class="token punctuation">[</span>info setObject<span class="token punctuation">:</span>@<span class="token punctuation">(</span>self<span class="token punctuation">.</span>player<span class="token punctuation">.</span>playTime<span class="token punctuation">.</span>intValue<span class="token punctuation">)</span> forKey<span class="token punctuation">:</span>MPNowPlayingInfoPropertyElapsedPlaybackTime<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true"> //音乐的播放速度
</span>    <span class="token punctuation">[</span>info setObject<span class="token punctuation">:</span>@<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> forKey<span class="token punctuation">:</span>MPNowPlayingInfoPropertyPlaybackRate<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true"> //音乐的总时间
</span>    <span class="token punctuation">[</span>info setObject<span class="token punctuation">:</span>@<span class="token punctuation">(</span>self<span class="token punctuation">.</span>player<span class="token punctuation">.</span>playDuration<span class="token punctuation">.</span>intValue<span class="token punctuation">)</span> forKey<span class="token punctuation">:</span>MPMediaItemPropertyPlaybackDuration<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true"> //音乐的封面
</span>    MPMediaItemArtwork <span class="token operator">*</span> artwork <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>MPMediaItemArtwork alloc<span class="token punctuation">]</span> initWithImage<span class="token punctuation">:</span>_player<span class="token punctuation">.</span>coverImg<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token punctuation">[</span>info setObject<span class="token punctuation">:</span>artwork forKey<span class="token punctuation">:</span>MPMediaItemPropertyArtwork<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment" spellcheck="true"> //完成设置
</span>    <span class="token punctuation">[</span><span class="token punctuation">[</span>MPNowPlayingInfoCenter defaultCenter<span class="token punctuation">]</span>setNowPlayingInfo<span class="token punctuation">:</span>info<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>

<p>Now Playing Center 并不需要每一秒都去刷新 (设置), 它是根据你设置的 PlaybackRate 来计算进度条展示的进度, 比如你 PlaybackRate 传 1，那就是1秒刷新一次进度显示, 当然暂停播放的时候它也会自动暂停.</p>

<p>那什么时候设置 Now Playing Center 比较合适呢? 对于播放网络音乐来说, 需要刷新的有几个时间点: 当前播放的歌曲变化时 (如切换到下一首) 当前歌曲信息变化时 (如从Unknown到ReadyToPlay) 当前歌曲拖动进度时.</p>

<h2 id="">关于总体的播放逻辑</h2>

<p>总结一下音乐播放器的播放逻辑:</p>

<ol>
<li>初始化播放界面</li>
<li>从接口获取播放列表 选择第一首为当前播放歌曲.</li>
<li>根据当前歌曲初始化播放器 、同步歌曲信息到播放界面 (此时播放界面应展示歌曲信息, 但是播放按钮应不可用且有 loading 之类的提示表示正在加载歌曲) 同步歌曲信息到 Now Playing Center.</li>
<li>当播放器的 status 变为 Ready To Play 时, 播放歌曲、同步播放信息到播放界面 (播放时间 总时间 进度条等等)  同步播放信息到 Now Playing Center.</li>
<li>当用户进行暂停操作时, 刷新播放界面.</li>
<li>当用户进行下一首 上一首操作时, 或完成某一首歌曲的播放时, 将对应的歌曲设置为当前播放歌曲, 重复3-5步骤.</li>
<li>由于网络情况不好造成播放器自动暂停播放时, 应刷新播放界面.</li>
<li>由于网络情况不好造成播放器不能进入播放状态时, 应有所处理 (比如提示耐心等待或者播放本地离线的歌曲).</li>
</ol>

<h2 id="">后记</h2>

<p>本文仅以实现基本功能的角度介绍了 AVPlayer 来播放网络音乐的实现, 事实上 AVPlayer 的功能不仅于此, 有兴趣的同学可以深入学习AVFoundation Framework.</p>

<p>如有读者需要类似豆瓣电台 APP 的项目 demo 可以到<a href="http://www.jianshu.com/p/819fbc4934d2">电台律动</a>下载学习。</p>

<hr>

<p><a href="http://www.jianshu.com/p/32b932f44c9b">原文链接</a></p>
<!-- content end -->
</div>
<br>
<br>
    <div id="disqus_thread"></div>
	<div class="footer">
		<p>© Copyright 2014 by isnowfy, Designed by isnowfy</p>
	</div>
</div>
<script src="main.js"></script>
<script id="content" type="text/mustache">
    <h1>{{title}}</h1>
    <div class="tag">
    {{date}}
    {{#tags}}
    <a href="/#/tag/{{name}}">#{{name}}</a>
    {{/tags}}
    </div>
</script>
<script id="pagesTemplate" type="text/mustache">
    {{#pages}}
    <li>
        <a href="{{path}}">{{title}}</a>
    </li>
    {{/pages}}
</script>
<script>
$(document).ready(function() {
    $.ajax({
        url: "main.json",
        type: "GET",
        dataType: "json",
        success: function(data) {
            $("#title").html(data.name);
            var pagesTemplate = Hogan.compile($("#pagesTemplate").html());
            var pagesHtml = pagesTemplate.render({"pages": data.pages});
            $("#pages").append(pagesHtml);
            //path
            var path = "ios_audio_2.html";
            //path end
            var now = 0;
            for (var i = 0; i < data.posts.length; ++i)
                if (path == data.posts[i].path)
                    now = i;
            var post = data.posts[now];
            var tmp = post.tags.split(" ");
            var tags = [];
            for (var i = 0; i < tmp.length; ++i)
                if (tmp[i].length > 0)
                    tags.push({"name": tmp[i]});
            var contentTemplate = Hogan.compile($("#content").html());
            var contentHtml = contentTemplate.render({"title": post.title, "tags": tags, "date": post.date});
            $("#main").prepend(contentHtml);
            if (data.disqus_shortname.length > 0) {
                var disqus_shortname = data.disqus_shortname;
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            }
        }
    });
});
</script>
<script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ["\\(", "\\)"]], processEscapes: true}});
</script>
</body>
</html>
